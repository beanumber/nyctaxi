---
title: "NYC's Taxi and Limousine Commission (TLC) Trip Data"
author: "Trang Le & Wencong (Priscilla) Li"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{NYCTAXI DATA}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## NYC Taxi

NYC's Taxi and Limousine Commission (TLC) Trip Data is a collection of trip records including fields capturing pick-up and drop-off locations, times, trip distances, fares, rate types, and driver-reported passenger counts. The data was collected and provided to the NYC TLC by technology providers under the Taxicab & Livery Passenger Enhancement Programs. 

## Getting started
To start using the package, load the 'nyctaxi' package into your R session. Since the 'nyctaxi' package currently lives on GitHub and not on CRAN, you have to install it using 'devtools'.

```{r}
#install.packages("devtools")
#devtools::install_github("beanumber/nyctaxi")
```

## Using the NYC Taxi Trip Data
Two dataframes are included in this package: 'green_2016_01_sample' and 'yellow_2016_01_sample'. There are random samples of 1000 observations generated by the 'sample' function in base R from the 2016 January green and yellow taxi trip data.

```{r}
library(nyctaxi)
data(green_2016_01_sample)
head(green_2016_01_sample)
```

## Extracting, Transforming and Loading the data

To access data during wider time spans, make use of the ['etl' package](https://github.com/beanumber/etl) to download the data and import it into a database. Please see the documentation for 'etl_extract' for further details and examples.

```{r}
help("etl_extract.etl_nyctaxi")
```

The code below creates a directory on your local desktop and downloads NYC taxicab trip data from Janaury, 2016 to your local directory. It also transforms/cleans the data and loads it to a sqlite database.  
```{r, eval=FALSE}
taxi <- etl("nyctaxi", dir = "~/Desktop/nyctaxi/")

taxi %>%
  etl_extract(years = 2016, months = 1, types = c("green")) %>% 
  etl_transform(years = 2016, months = 1, types = c("green")) %>% 
  etl_load(years = 2016, months = 1, types = "green")}
```
## Using the NYC Green Taxi Trip Data

```{r}
library(dplyr)
library(leaflet)
library(lubridate)
```

We visualize pickup and dropoff location for the 1000 trips in the dataset. 

```{r, eval=FALSE}
my_trips <- green_2016_01_sample
#clean_up data according to date and time of pickup
one_cab <- my_trips %>% filter(pickup_longitude != 0)
leaflet(data = one_cab) %>% 
  addTiles() %>% 
  addCircles(lng = ~pickup_longitude, lat = ~pickup_latitude) %>% 
  addCircles(lng = ~dropoff_longitude, lat = ~dropoff_latitude, color = "green")
```


We use the lubridate package to convert date time data and get summary statistics on Friday trips
```{r, eval=FALSE}

one_cab = one_cab %>% 
  mutate(tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime)) %>%     mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime)) %>% 
  mutate(weekday_pickup = wday(tpep_pickup_datetime,label=T)) %>%    mutate(weekday_dropoff=wday(tpep_dropoff_datetime,label=T))

mosaic::tally(~weekday_dropoff, data=one_cab)

one_cab %>% 
  group_by(as.Date(tpep_pickup_datetime)) %>%
  summarize(N = n(), avg_dist = mean(trip_distance), 
            avg_passengers = mean(passenger_count), 
            avg_fare = mean(fare_amount))
```

Take a random sample of 25000 observations to compare trip statistics for different days of the week
```{r, eval=FALSE}
set.seed(7)

sample <- my_trips %>% filter(pickup_longitude != 0) %>% collect(n=1000000)

rows <- sample(1:1000000,25000)

sample %>% slice(rows)

#do the same data cleaning process
sample = sample %>% 
  mutate(tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime)) %>%     mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime)) %>% 
  mutate(weekday_pickup = wday(tpep_pickup_datetime,label=T)) %>%    mutate(weekday_dropoff=wday(tpep_dropoff_datetime,label=T))

tally(~weekday_pickup,data=sample)
```

We can also get summary statistics for different days of the week:
```{r, eval=FALSE}
sample %>% group_by(weekday_pickup) %>% 
  summarize(N = n(), avg_dist = mean(trip_distance), 
            avg_passengers = mean(passenger_count), 
            avg_fare = mean(fare_amount)) 

small_sample <- sample %>% filter(weekday_pickup=="Mon")%>% head(100) 

leaflet(data = small_sample) %>% 
  addTiles() %>% 
  addCircles(lng = ~pickup_longitude, lat = ~pickup_latitude) %>% 
  addCircles(lng = ~dropoff_longitude, lat = ~dropoff_latitude, color = "green")
```

```{r, eval=FALSE, include=FALSE}
#try to look at rush hour pickups and compare to weekdays pickups
rush_hour <- sample %>% filter(hour(tpep_pickup_datetime) >= 5, hour(tpep_pickup_datetime) < 7)

rush_hour %>% group_by(weekday_pickup) %>% 
  summarize(N = n(), avg_dist = mean(trip_distance), 
            avg_passengers = mean(passenger_count), 
            avg_fare = mean(fare_amount)) 
```
It looks like on Sunday and Saturday, the trip distance and fair increase for rush hour pickups. 

