---
title: "New York City's Taxi and Limousine Commission (TLC) Trip Data"
author: "Wencong (Priscilla) Li & Trang Le"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{NYCTAXI DATA}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## NYC Taxi Trip Data

NYC's [Taxi and Limousine Commission Trip Data](http://www.nyc.gov/html/tlc/html/about/trip_record_data.shtml) is a collection of trip records including fields capturing pick-up and drop-off locations, times, trip distances, fares, rate types, and driver-reported passenger counts. The data was collected and provided to the NYC TLC by technology providers under the Taxicab & [Livery Passenger Enhancement Programs](http://www.nyc.gov/html/tlc/html/industry/shl.shtml). 

## Getting started
To start using the package, load the 'nyctaxi' package into your R session. Since the 'nyctaxi' package currently lives on CRAN now, you can install it from CRAN:

```{r}
#install.packages("nyctaxi")
library(nyctaxi)
```

## Using the NYC Taxi Trip Data
Some data are attached to this package: 'green_2016_01_sample' and 'yellow_2016_01_sample'are two of them. They are random samples of 1000 observations generated by the 'sample' function in base R from the 2016 January green and yellow taxi trip data.

There are some data entry error. In order to eliminate the data entry error, let's limit the ranges of lngitude and latitude. 

```{r, warning=FALSE, message=FALSE}
data(green_2016_01_sample)
head(green_2016_01_sample)
green_2016_01_sample <- green_2016_01_sample %>%
  filter(40.4 < pickup_latitude && pickup_latitude < 41) %>%
  filter(-74.5 < pickup_longitude && pickup_longitude < -73.5) %>%
  filter(40.4 < dropoff_latitude && dropoff_latitude < 41) %>%
  filter(-74.5 < dropoff_longitude && dropoff_longitude < -73.5)
```

## Extracting, Transforming and Loading the data
To access data during wider time spans, make use of the ['etl' package](https://github.com/beanumber/etl) to download the data and import it into a database. Please see the documentation for 'etl_extract' for further details and examples.

```{r, warning=FALSE, message=FALSE}
help("etl_extract.etl_nyctaxi")
```

The code below creates a directory on your local desktop and downloads NYC taxicab trip data from Janaury, 2016 to your local directory. It also transforms/cleans the data and loads it to a sqlite database.  
```{r, eval=FALSE, warning=FALSE, message=FALSE}
taxi <- etl("nyctaxi", dir = "~/Desktop/nyctaxi/")

taxi %>%
  etl_extract(years = 2016, months = 1, types = c("green")) %>% 
  etl_transform(years = 2016, months = 1, types = c("green")) %>% 
  etl_load(years = 2016, months = 1, types = "green")}
```

## Using the NYC Green Taxi Trip Data
You willl need the following R packages:
```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(leaflet)
library(lubridate)
```

### Visualization
We can use `leaflet` to visualize the pickup and dropoff locations of the 1000 trips in the green taxi trip dataset:
```{r, warning=FALSE, message=FALSE}
my_trips <- green_2016_01_sample

#clean_up data according to date and time of pickup
map <- leaflet(data = green_2016_01_sample) %>% 
  addTiles() %>% 
  addCircles(lng = ~pickup_longitude, lat = ~pickup_latitude, color = "red") %>% 
  addCircles(lng = ~dropoff_longitude, lat = ~dropoff_latitude, color = "green")
setView(map, lat = 40.730610, lng = -73.935242, zoom = 10);
```

There are also shapefiles of NYC Taxi zone attached to `nyctaxi` R package.
```{r, warning=FALSE, message=FALSE}
data("taxi_zones")

leaflet(data = taxi_zones) %>% 
  addTiles() %>% 
  addPolygons()

```


### Play with Datetime Variable
We can use `lubridate` to clean datetime variable:
```{r, warning=FALSE, message=FALSE}

clean_datetime <- my_trips %>% 
  mutate(lpep_pickup_datetime = ymd_hms(lpep_pickup_datetime)) %>%
  mutate(lpep_dropoff_datetime = ymd_hms(lpep_dropoff_datetime)) %>% 
  mutate(weekday_pickup = weekdays(lpep_pickup_datetime)) %>%
  mutate(weekday_dropoff= weekdays(lpep_dropoff_datetime))
```

We can now analyze the number of trips occurred on each day of a week:
```{r, warning=FALSE, message=FALSE}
clean_datetime %>% 
  group_by(weekday_pickup) %>%
  summarize(N = n(), avg_dist = mean(trip_distance), 
            avg_passengers = mean(passenger_count), 
            avg_price = mean(total_amount))
```
It looks like on Friday and Saturday had the most trips.

