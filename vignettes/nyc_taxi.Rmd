---
title: "Vignette Title"
author: "Trang Le"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{NYCTAXI DATA}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## NYCTaxi

NYC's Taxi and Limousine Commission (TLC) Trip Data is a collection of trip records including fields capturing pick-up and drop-off locations, times, trip distances, fares, rate types, and driver-reported passenger counts. The data was collected and provided to the NYC TLC by technology providers under the Taxicab & Livery Passenger Enhancement Programs. 
ss

## Extracting, Transforming and Loading the data
```{r}
library(etl)
library(nyctaxi)
library(lubridate)
library(mosaic)
taxi <- etl("nyctaxi", dir = "~/dumps/nyctaxi/")
taxi %>% etl_extract() #default argument for month is 1, range from 1-12
taxi %>% etl_transform() #copy file from raw to load folder
taxi %>% etl_load() #load the dataset into an sql database
```
Or, we can use etl_update() altogether
```{r,eval=FALSE}
taxi %>% etl_update()
```

We visualize pickup and dropoff location for the first 500 trips in the dataset. 

```{r}
my_trips <- tbl(taxi, "trips")
#clean_up data according to date and time of pickup
one_cab <- my_trips %>% filter(pickup_longitude != 0) %>% head(500) %>% collect() 
library(leaflet)
leaflet(data = one_cab) %>% 
  addTiles() %>% 
  addCircles(lng = ~pickup_longitude, lat = ~pickup_latitude) %>% 
  addCircles(lng = ~dropoff_longitude, lat = ~dropoff_latitude, color = "green")
```


We use the lubridate package to convert date time data and get summary statistics on Friday trips
```{r}
library(lubridate)
one_cab = one_cab %>% 
  mutate(tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime)) %>%     mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime)) %>% 
  mutate(weekday_pickup = wday(tpep_pickup_datetime,label=T)) %>%    mutate(weekday_dropoff=wday(tpep_dropoff_datetime,label=T))

tally(~weekday_dropoff, data=one_cab)

one_cab %>% 
  group_by(as.Date(tpep_pickup_datetime)) %>%
  summarize(N = n(), avg_dist = mean(trip_distance), 
            avg_passengers = mean(passenger_count), 
            avg_fare = mean(fare_amount))
```

Take a random sample of 25000 observations to compare trip statistics for different days of the week
```{r}
set.seed(7)

sample <- my_trips %>% filter(pickup_longitude != 0) %>% collect(n=1000000)

rows <- sample(1:1000000,25000)

sample %>% slice(rows)

#do the same data cleaning process
sample = sample %>% 
  mutate(tpep_pickup_datetime = ymd_hms(tpep_pickup_datetime)) %>%     mutate(tpep_dropoff_datetime = ymd_hms(tpep_dropoff_datetime)) %>% 
  mutate(weekday_pickup = wday(tpep_pickup_datetime,label=T)) %>%    mutate(weekday_dropoff=wday(tpep_dropoff_datetime,label=T))

tally(~weekday_pickup,data=sample)
```

We can also get summary statistics for different days of the week:
```{r}
sample %>% group_by(weekday_pickup) %>% 
  summarize(N = n(), avg_dist = mean(trip_distance), 
            avg_passengers = mean(passenger_count), 
            avg_fare = mean(fare_amount)) 

small_sample <- sample %>% filter(weekday_pickup=="Mon")%>% head(100) 

leaflet(data = small_sample) %>% 
  addTiles() %>% 
  addCircles(lng = ~pickup_longitude, lat = ~pickup_latitude) %>% 
  addCircles(lng = ~dropoff_longitude, lat = ~dropoff_latitude, color = "green")
```

```{r,include=FALSE}
#try to look at rush hour pickups and compare to weekdays pickups
rush_hour <- sample %>% filter(hour(tpep_pickup_datetime) >= 5, hour(tpep_pickup_datetime) < 7)

rush_hour %>% group_by(weekday_pickup) %>% 
  summarize(N = n(), avg_dist = mean(trip_distance), 
            avg_passengers = mean(passenger_count), 
            avg_fare = mean(fare_amount)) 
```
It looks like on Sunday and Saturday, the trip distance and fair increase for rush hour pickups. 

